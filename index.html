<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass√© Compos√© Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .game-container {
            max-width: 700px;
            width: 100%;
            background-color: #ffffff;
            border: 2px solid #3b82f6; /* Blue border */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            padding: 30px;
            margin-top: 50px;
        }
        .title {
            color: #1e40af; /* Darker Blue */
            font-size: 2.25rem;
            font-weight: 700;
        }
        input {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.2s;
        }
        input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            outline: none;
        }
        button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #check-button {
            background-color: #10b981; /* Emerald Green */
            color: white;
            font-weight: 600;
            padding: 12px;
            border-radius: 8px;
        }
        #check-button:hover {
            background-color: #059669;
        }
        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 600;
            border-left: 5px solid;
        }
        .correct {
            background-color: #d1fae5; 
            color: #065f46; 
            border-color: #10b981;
        }
        .incorrect {
            background-color: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444;
        }
        .question-card {
            min-height: 120px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .instruction-box {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #1e40af;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1 class="title text-center mb-4">Pass√© Compos√© Master üá´üá∑</h1>
        <p class="text-center text-gray-600 mb-6">Master your **√™tre**, **avoir**, irregulars, negation, and agreement!</p>

        <!-- Instructions -->
        <div class="instruction-box">
            <p><strong>Instructions:</strong> Conjugate the verb using the two input fields.</p>
            <ul class="list-disc ml-5 mt-2">
                <li>**Auxiliaire Field:** Enter the auxiliary verb (*suis*, *a*, *avons*, etc.), including the reflexive pronoun (*me*, *t'*, *se*) AND the **ne** if negative.</li>
                <li>**Participe Field:** Enter the past participle (*all√©*, *vu*, *fait*, etc.), including the correct **agreement** (*-e, -s, -es*) AND **pas** if negative (for *avoir* verbs).</li>
            </ul>
        </div>

        <!-- Score and Progress -->
        <div class="flex justify-between items-center mb-6 text-lg font-semibold text-gray-700">
            <div>Score: <span id="score">0</span></div>
            <div>Question: <span id="current-q">1</span> / <span id="total-q">10</span></div>
        </div>

        <!-- Question Display -->
        <div id="question-card" class="question-card">
            <p class="text-lg font-medium text-gray-800 mb-4">Conjugate the verb:</p>
            <p id="sentence" class="text-2xl font-bold text-blue-900 mb-3"></p>
            <p id="verb-info" class="text-base text-blue-700 italic"></p>
        </div>

        <!-- Input Area -->
        <div class="space-y-4">
            <div class="input-group">
                <label for="auxiliary-input" class="block text-sm font-medium text-gray-700">Auxiliaire (+ Refl. Pronoun / Ne...):</label>
                <input type="text" id="auxiliary-input" placeholder="Ex: ai, sommes, me suis, n'ai" class="mt-1 block w-full">
            </div>
            <div class="input-group">
                <label for="participle-input" class="block text-sm font-medium text-gray-700">Participe Pass√© (+ Accord / ...pas):</label>
                <input type="text" id="participle-input" placeholder="Ex: mang√©, sorti(e), venu(e)s, pas vu" class="mt-1 block w-full">
            </div>
            <button id="check-button" onclick="checkAnswer()" class="w-full">V√©rifier (Check)</button>
        </div>
        
        <!-- Feedback -->
        <div id="feedback-message" class="feedback hidden"></div>

        <!-- Hint Box -->
        <div id="hint-box" class="instruction-box hidden">
            <p class="font-bold mb-1">HINT:</p>
            <p id="hint-text"></p>
        </div>
    </div>

    <!-- Final Score Modal -->
    <div id="final-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">Unit Test Prep Complete! üöÄ</h2>
            <p class="text-xl text-gray-700 mb-6">Review your score and try again to master all concepts.</p>
            <p class="text-4xl font-extrabold text-gray-900 mb-6">Final Score: <span id="final-score"></span> / 10</p>
            <button onclick="restartGame()" class="py-3 px-6 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">Restart Test</button>
        </div>
    </div>

    <script>
        // Utility function to clean and normalize input for robust comparison
        function normalizeInput(str) {
            if (!str) return '';
            // 1. Lowercase
            str = str.toLowerCase().trim();
            // 2. Remove common French accents (important for matching 'est' vs 'e' vs '√©')
            str = str.replace(/√†/g, 'a').replace(/√©|√®|√™|√´/g, 'e').replace(/√Æ|√Ø/g, 'i').replace(/√¥|√∂/g, 'o').replace(/√π|√º/g, 'u').replace(/√ß/g, 'c');
            // 3. Remove spaces and only allow letters and apostrophes for core comparison
            return str.replace(/[^a-z']/g, ''); 
        }

        // Data derived from the user's uploaded images
        // Dr. & Mrs. P. VANDERTRAMP verbs (use √äTRE)
        const ETRE_VERBS = {
            'devenir': { pp: 'devenu', verb_type: 'VANDERTRAMP' }, 'revenir': { pp: 'revenu', verb_type: 'VANDERTRAMP' },
            'monter': { pp: 'mont√©', verb_type: 'VANDERTRAMP' }, 'rester': { pp: 'rest√©', verb_type: 'VANDERTRAMP' },
            'sortir': { pp: 'sorti', verb_type: 'VANDERTRAMP' }, 'venir': { pp: 'venu', verb_type: 'VANDERTRAMP' },
            'aller': { pp: 'all√©', verb_type: 'VANDERTRAMP' }, 'na√Ætre': { pp: 'n√©', verb_type: 'VANDERTRAMP' },
            'descendre': { pp: 'descendu', verb_type: 'VANDERTRAMP' }, 'entrer': { pp: 'entr√©', verb_type: 'VANDERTRAMP' },
            'rentrer': { pp: 'rentr√©', verb_type: 'VANDERTRAMP' }, 'tomber': { pp: 'tomb√©', verb_type: 'VANDERTRAMP' },
            'retourner': { pp: 'retourn√©', verb_type: 'VANDERTRAMP' }, 'arriver': { pp: 'arriv√©', verb_type: 'VANDERTRAMP' },
            'mourir': { pp: 'mort', verb_type: 'VANDERTRAMP' }, 'partir': { pp: 'parti', verb_type: 'VANDERTRAMP' },
            // Reflexive Verbs (use √äTRE + agreement)
            'se laver': { pp: 'lav√©', verb_type: 'Reflexive' }, 'se d√©p√™cher': { pp: 'd√©p√™ch√©', verb_type: 'Reflexive' },
            's\'habiller': { pp: 'habill√©', verb_type: 'Reflexive' }, 'se promener': { pp: 'promen√©', verb_type: 'Reflexive' },
            'se coucher': { pp: 'couch√©', verb_type: 'Reflexive' }, 'se r√©veiller': { pp: 'r√©veill√©', verb_type: 'Reflexive' } 
        };

        // Irregular verbs using AVOIR (from the tables)
        const AVOIR_IRREGULAR_VERBS = {
            'avoir': { pp: 'eu', group: '-u' }, 'boire': { pp: 'bu', group: '-u' }, 'conna√Ætre': { pp: 'connu', group: '-u' }, 'croire': { pp: 'cru', group: '-u' },
            'devoir': { pp: 'd√ª', group: '-u' }, 'lire': { pp: 'lu', group: '-u' }, 'pleuvoir': { pp: 'plu', group: '-u' }, 'pouvoir': { pp: 'pu', group: '-u' },
            'recevoir': { pp: 're√ßu', group: '-u' }, 'savoir': { pp: 'su', group: '-u' }, 'voir': { pp: 'vu', group: '-u' }, 'vouloir': { pp: 'voulu', group: '-u' },
            'courir': { pp: 'couru', group: '-u' }, 'mettre': { pp: 'mis', group: '-is' }, 'prendre': { pp: 'pris', group: '-is' },
            'conduire': { pp: 'conduit', group: '-it' }, 'dire': { pp: 'dit', group: '-it' }, '√©crire': { pp: '√©crit', group: '-it' },
            '√™tre': { pp: '√©t√©', group: 'Other' }, 'faire': { pp: 'fait', group: 'Other' }, 'offrir': { pp: 'offert', group: 'Other' }, 'ouvrir': { pp: 'ouvert', group: 'Other' },
            'vendre': { pp: 'vendu', group: 'Regular -re' }, 'manger': { pp: 'mang√©', group: 'Regular -er' }, 'finir': { pp: 'fini', group: 'Regular -ir' },
            'apprendre': { pp: 'appris', group: '-is' }, 'assister': { pp: 'assist√©', group: 'Regular -er' }, 'choisir': { pp: 'choisi', group: 'Regular -ir' } 
        };

        // Pronouns and their characteristics (Subject, Pronoun, Aux Avoir, Aux √ätre, Agreement Suffix)
        const PRONOUNS = [
            { subject: 'Je (masc)', pronoun: 'je', aux_avoir: 'ai', aux_etre: 'suis', agreement: '' },
            { subject: 'Je (f√©m)', pronoun: 'je', aux_avoir: 'ai', aux_etre: 'suis', agreement: 'e' },
            { subject: 'Tu (masc)', pronoun: 'tu', aux_avoir: 'as', aux_etre: 'es', agreement: '' },
            { subject: 'Tu (f√©m)', pronoun: 'tu', aux_avoir: 'as', aux_etre: 'es', agreement: 'e' },
            { subject: 'Il / Le gar√ßon', pronoun: 'il', aux_avoir: 'a', aux_etre: 'est', agreement: '' },
            { subject: 'Elle / Maman', pronoun: 'elle', aux_avoir: 'a', aux_etre: 'est', agreement: 'e' },
            { subject: 'Nous (mixte)', pronoun: 'nous', aux_avoir: 'avons', aux_etre: 'sommes', agreement: 's' },
            { subject: 'Nous (f√©m)', pronoun: 'nous', aux_avoir: 'avons', aux_etre: 'sommes', agreement: 'es' },
            { subject: 'Vous (mixte)', pronoun: 'vous', aux_avoir: 'avez', aux_etre: '√™tes', agreement: 's' },
            { subject: 'Vous (f√©m)', pronoun: 'vous', aux_avoir: 'avez', aux_etre: '√™tes', agreement: 'es' },
            { subject: 'Ils / Les gar√ßons', pronoun: 'ils', aux_avoir: 'ont', aux_etre: 'sont', agreement: 's' },
            { subject: 'Elles / Les filles', pronoun: 'elles', aux_avoir: 'ont', aux_etre: 'sont', agreement: 'es' },
        ];

        // Combine all verbs
        const ALL_VERBS = { ...ETRE_VERBS, ...AVOIR_IRREGULAR_VERBS };

        const QUESTION_COUNT = 10;
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isChecking = false;

        /**
         * Selects a random set of questions from the verb pool.
         */
        function initializeQuestions() {
            questions = [];
            const verbInfinitives = Object.keys(ALL_VERBS);

            for (let i = 0; i < QUESTION_COUNT; i++) {
                let verb, verbData, pronounData;
                let isNegative = Math.random() < 0.3; // 30% chance of negation

                // Weighted random selection: ~35% Avoir, ~35% VANDERTRAMP, ~30% Reflexive
                let targetType = Math.random();

                const filteredVerbs = verbInfinitives.filter(v => {
                    const data = ALL_VERBS[v];
                    if (targetType < 0.35 && !data.verb_type.includes('VANDERTRAMP') && !data.verb_type.includes('Reflexive')) return true;
                    if (targetType >= 0.35 && targetType < 0.7 && data.verb_type === 'VANDERTRAMP') return true;
                    if (targetType >= 0.7 && data.verb_type === 'Reflexive') return true;
                    return false;
                });
                
                if (filteredVerbs.length === 0) { // Fallback if filtered list is empty (shouldn't happen with this large list)
                    verb = verbInfinitives[Math.floor(Math.random() * verbInfinitives.length)];
                } else {
                    verb = filteredVerbs[Math.floor(Math.random() * filteredVerbs.length)];
                }

                verbData = ALL_VERBS[verb];

                // Select a pronoun/subject
                let possiblePronouns = PRONOUNS;
                if (verb.startsWith('se ') || verb.startsWith('s\'')) {
                    // For reflexive, exclude non-personal subjects like 'Le gar√ßon'
                    possiblePronouns = PRONOUNS.filter(p => p.pronoun.length <= 4); 
                }
                pronounData = possiblePronouns[Math.floor(Math.random() * possiblePronouns.length)];

                const sentenceTemplate = `... (le verbe ${verb}) ...`;
                
                questions.push(generateCorrectAnswer(pronounData, verb, verbData, sentenceTemplate, isNegative));
            }
            currentQuestionIndex = 0;
            score = 0;
            updateScoreDisplay();
            loadQuestion();
        }

        /**
         * Calculates the correct answer for the question.
         */
        function generateCorrectAnswer(pronounData, verb, verbData, sentenceTemplate, isNegative) {
            const isEtre = verbData.verb_type.includes('VANDERTRAMP') || verbData.verb_type.includes('Reflexive');
            const aux = isEtre ? pronounData.aux_etre : pronounData.aux_avoir;
            const pp = verbData.pp;
            let verbInfinitive = verb;

            // --- 1. Determine Reflexive Pronoun ---
            let reflexivePrefix = '';
            let subjectPronoun = pronounData.pronoun;

            if (isEtre && verbData.verb_type.includes('Reflexive')) {
                // Determine reflexive pronoun (me/te/se/nous/vous/se)
                switch (subjectPronoun) {
                    case 'je': reflexivePrefix = 'me '; break;
                    case 'tu': reflexivePrefix = 'te '; break;
                    case 'il': case 'elle': reflexivePrefix = 'se '; break;
                    case 'nous': reflexivePrefix = 'nous '; break;
                    case 'vous': reflexivePrefix = 'vous '; break;
                    case 'ils': case 'elles': reflexivePrefix = 'se '; break;
                }
                
                // Handle vowel contraction for the reflexive pronoun (m', t', s')
                if (aux.match(/^[aeiou]/i)) {
                    if (reflexivePrefix === 'me ') reflexivePrefix = 'm\'';
                    else if (reflexivePrefix === 'te ') reflexivePrefix = 't\'';
                    else if (reflexivePrefix === 'se ') reflexivePrefix = 's\'';
                }
            }

            // --- 2. Determine Agreement ---
            const agreement = isEtre ? pronounData.agreement : '';

            // --- 3. Construct Auxiliary Input (Box 1) ---
            let expectedAuxInput;
            
            if (isNegative) {
                // Negation: ne [refl] [aux]
                let nePrefix = (aux.match(/^[aeiou]/i) && !reflexivePrefix.endsWith('\'')) ? 'n\'' : 'ne ';
                
                if (reflexivePrefix.endsWith('\'')) {
                     // If reflexive is contracted (m', t', s'), 'ne' usually precedes it: "ne m'es..."
                    expectedAuxInput = `ne ${reflexivePrefix}${aux}`;
                } else {
                    // Combine ne, refl, and aux, handling contraction for ne
                    expectedAuxInput = `${nePrefix}${reflexivePrefix}${aux}`;
                }
                expectedAuxInput = expectedAuxInput.replace(/\s+/g, ' ').trim();

            } else {
                // Affirmative: [refl] [aux]
                expectedAuxInput = `${reflexivePrefix}${aux}`.replace(/\s+/g, ' ').trim();
            }


            // --- 4. Construct Participle Input (Box 2) ---
            let expectedPPInput = pp + agreement;

            if (isNegative && !isEtre) {
                // AVOIR negation places 'pas' after the PP (in the context of the user's worksheet structure)
                expectedPPInput = pp + ' pas';
            }
            // For √äTRE negation, 'pas' is technically before the PP, but we assume user puts PP+Agreement in box 2

            // --- 5. Construct Full Answer (for Feedback) ---
            let fullAnswer;
            if (isNegative) {
                // The full conjugated phrase (Subject + Aux field + pas [PP field])
                const auxPart = expectedAuxInput.replace('ne ', '').replace('n\'', ''); // just the aux part for 'pas' placement
                
                if (isEtre) {
                    // ne [refl] [aux] pas [pp][agreement]
                    fullAnswer = `${expectedAuxInput} pas ${pp}${agreement}`;
                } else {
                    // ne [aux] pas [pp]
                    fullAnswer = `${expectedAuxInput} pas ${pp}`; 
                }
            } else {
                // [refl] [aux] [pp][agreement]
                fullAnswer = `${expectedAuxInput} ${pp}${agreement}`;
            }
            fullAnswer = fullAnswer.replace(/\s+/g, ' ').trim();

            return {
                subject: pronounData.subject,
                verb: verbInfinitive,
                sentenceTemplate: `**${pronounData.subject}** ${sentenceTemplate}`,
                isEtre: isEtre,
                isNegative: isNegative,
                hint: `Auxiliary: **${isEtre ? '√äTRE' : 'AVOIR'}**. ${isEtre ? `Check for Agreement (suffix: -${agreement || 'none'}) and the reflexive pronoun.` : 'Check for the irregular participle.'}`,
                expectedAuxInput: expectedAuxInput,
                expectedPP: pp, // Base PP
                expectedPPInput: expectedPPInput,
                fullAnswer: fullAnswer,
                agreementSuffix: agreement
            };
        }

        /**
         * Loads the current question into the display.
         */
        function loadQuestion() {
            if (currentQuestionIndex >= QUESTION_COUNT) {
                showFinalScoreModal();
                return;
            }

            const q = questions[currentQuestionIndex];

            // Reset inputs and feedback
            document.getElementById('auxiliary-input').value = '';
            document.getElementById('participle-input').value = '';
            document.getElementById('feedback-message').classList.add('hidden');
            document.getElementById('hint-box').classList.add('hidden');
            document.getElementById('check-button').disabled = false;
            document.getElementById('check-button').textContent = 'V√©rifier (Check)';
            isChecking = false;

            // Update display
            document.getElementById('current-q').textContent = currentQuestionIndex + 1;
            document.getElementById('sentence').innerHTML = q.sentenceTemplate;
            
            let info = q.isEtre ? 'Auxiliaire: <span class="text-blue-900 font-bold">√äTRE</span>' : 'Auxiliaire: <span class="text-blue-900 font-bold">AVOIR</span>';
            if (q.isNegative) {
                info += ' | Forme: <span class="text-red-600 font-bold">N√âGATIVE</span>';
            }
            if (q.isEtre && q.agreementSuffix) {
                info += ` | <span class="text-red-600 font-bold">ACCORD REQUIS: -${q.agreementSuffix}</span>`;
            }
            document.getElementById('verb-info').innerHTML = info;
        }

        /**
         * Compares the user's input with the correct answer.
         */
        function checkAnswer() {
            if (isChecking) {
                currentQuestionIndex++;
                loadQuestion();
                return;
            }

            const q = questions[currentQuestionIndex];
            const rawAuxInput = document.getElementById('auxiliary-input').value.trim();
            const rawPPInput = document.getElementById('participle-input').value.trim();

            const normalizedAuxInput = normalizeInput(rawAuxInput);
            const normalizedPPInput = normalizeInput(rawPPInput);

            // --- 1. Check Auxiliary Box ---
            const expectedNormalizedAux = normalizeInput(q.expectedAuxInput);
            let isAuxCorrect = normalizedAuxInput === expectedNormalizedAux;

            // --- 2. Check Participle Box ---
            const expectedNormalizedPP = normalizeInput(q.expectedPPInput);
            let isPPCorrect = normalizedPPInput === expectedNormalizedPP;


            // --- 3. Display Feedback ---
            let isCorrect = isAuxCorrect && isPPCorrect;
            const feedbackBox = document.getElementById('feedback-message');
            const hintBox = document.getElementById('hint-box');
            feedbackBox.classList.remove('hidden', 'correct', 'incorrect');
            hintBox.classList.remove('hidden');
            document.getElementById('hint-text').innerHTML = q.hint;

            if (isCorrect) {
                score++;
                feedbackBox.classList.add('correct');
                feedbackBox.innerHTML = `
                    <p>‚úÖ **CORRECT!**</p>
                    <p>Conjugation: **${q.fullAnswer}**</p>
                `;
            } else {
                feedbackBox.classList.add('incorrect');
                let auxError = isAuxCorrect ? '' : `<p class="mt-2">**Auxiliary Error:** Expected: **${q.expectedAuxInput}**</p>`;
                let ppError = isPPCorrect ? '' : `<p> **Participle Error:** Expected: **${q.expectedPPInput}**</p>`;

                feedbackBox.innerHTML = `
                    <p>‚ùå **INCORRECT.** Study the rule and try the next one.</p>
                    ${auxError}
                    ${ppError}
                    <p class="mt-2 text-sm">The complete conjugation is: **${q.fullAnswer}**.</p>
                `;
            }

            // --- 4. Prepare for Next Step ---
            document.getElementById('check-button').textContent = 'Continuer (Continue)';
            document.getElementById('check-button').disabled = false;
            isChecking = true;
            updateScoreDisplay();
        }

        /**
         * Updates the score and total question count display.
         */
        function updateScoreDisplay() {
            document.getElementById('score').textContent = score;
            document.getElementById('total-q').textContent = QUESTION_COUNT;
        }

        /**
         * Shows the final score modal.
         */
        function showFinalScoreModal() {
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-modal').classList.add('active');
        }

        /**
         * Restarts the game.
         */
        function restartGame() {
            document.getElementById('final-modal').classList.remove('active');
            initializeQuestions();
        }

        // Initial game start
        document.addEventListener('DOMContentLoaded', () => {
            initializeQuestions();
            document.getElementById('auxiliary-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkAnswer();
            });
            document.getElementById('participle-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkAnswer();
            });
        });
    </script>
</body>
</html>
